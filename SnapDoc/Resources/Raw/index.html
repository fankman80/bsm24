<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoAdmin Map</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #popup {
            position: absolute;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.5);
            width: 250px;
            font-family: "Aptos", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 14px;
            display: none;
            word-wrap: break-word;
            z-index: 9999;
            border: 1px solid gray;
        }

        #popupContent {
            margin-bottom: 10px; /* Abstand zum Button */
        }

        #sendButton {
            display: block;
            margin-left: auto; /* rechts ausrichten */
            margin-right: 0; /* rechts ausrichten */
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            background-color: #999999;
            color: #888888;
            cursor: pointer;
        }

        /* Rahmen-Pfeil (größeres Dreieck) */
        #popup::before {
            content: "";
            position: absolute;
            left: -11px; /* Etwas weiter links, damit der Rahmen sichtbar ist */
            top: 40px; /* Feste Position, z.B. 20px vom oberen Rand */
            border-top: 11px solid transparent;
            border-bottom: 11px solid transparent;
            border-right: 11px solid gray; /* Rahmenfarbe */
        }

        /* Innerer Pfeil (kleineres Dreieck) */
        #popup::after {
            content: "";
            position: absolute;
            left: -10px; /* Etwas nach innen verschoben, damit der Rahmen um den Pfeil entsteht */
            top: 41px;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid white; /* Gleiche Hintergrundfarbe wie das Popup */
        }

        #popup h4 {
            font-weight: bold;
            margin: 5px;
            color: #999999;
        }

        #popup p {
            margin: 5px 5px 15px 5px;
        }

        .popup-header {
            font-size: 14px;
            margin: 5px;
        }

        hr.solid {
            border: none;
            border-top: 1px solid #999999; /* Diese Farbe wird themenbezogen ersetzt */
            margin: 10px 0; /* Abstand um den Strich */
        }

        .ol-scale-line {
            background: rgba(255, 255, 255, 1);
            border: 1px solid #999;
            border-radius: 4px;
            padding: 2px 8px;
            bottom: 14px;
            left: 10px;
            font-family: "Aptos", "Segoe UI", sans-serif;
            font-size: 14px;
            color: #333;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .ol-scale-line-inner {
            color: #000;
        }

        .ol-zoom {
            border: 1px solid #999;
            border-radius: 4px;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .ol-rotate {
            border: 1px solid #999;
            border-radius: 4px;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="popup">
        <div id="popupContent"></div> <!-- dynamischer Pin-Inhalt -->
        <button id="sendButton">Pin ansehen</button> <!-- bleibt immer unten rechts -->
    </div>

    <script>
        var map, vectorSource, vectorLayer, wmsLayer, overlayLayer, mapReady = false;
        var pendingPositions = [];
        let currentPinkey = null;
        let currentPlankey = null;

        function initMap() {
            wmsLayer = new ol.layer.Tile({ source: new ol.source.TileWMS({ url: 'https://wms.geo.admin.ch/', params: { LAYERS: 'ch.swisstopo.pixelkarte-farbe', TILED: true }, serverType: 'mapserver' }) });
            overlayLayer = new ol.layer.Tile({ source: new ol.source.TileWMS({ url: 'https://wms.geo.admin.ch/', params: { LAYERS: '', TILED: true }, serverType: 'mapserver' }) });

            map = new ol.Map({
                target: 'map',
                layers: [wmsLayer, overlayLayer],
                view: new ol.View({
                    center: ol.proj.fromLonLat([{center_koord}]),
                    zoom: {mapzoom}
                })
            });

            var scaleLineControl = new ol.control.ScaleLine({ units: 'metric', bar: false, steps: 6, text: true, minWidth: 80, maxWidth: 140 });
            map.addControl(scaleLineControl);

            vectorSource = new ol.source.Vector();
            vectorLayer = new ol.layer.Vector({ source: vectorSource });
            map.addLayer(vectorLayer);

            var popup = new ol.Overlay({
                element: document.getElementById('popup'),
                positioning: 'bottom-center',
                stopEvent: true,
                offset: [30, -50]
            });
            map.addOverlay(popup);

            var modify = new ol.interaction.Modify({
                hitDetection: vectorLayer,
                source: vectorSource
            });
            map.addInteraction(modify);

            mapReady = true;

            // pendingPositions verarbeiten
            if (pendingPositions.length > 0) {
                pendingPositions.forEach(p => setMarkerPosition(p.lon, p.lat, p.pinname, p.pinlocation, p.pindesc, p.plankey, p.pinkey));
                pendingPositions = [];
            }

            map.on('click', function (evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
                    return feature;
                });

                var popupElement = document.getElementById('popup');
                var popupContent = document.getElementById('popupContent');

                if (feature && feature.get('pinname') !== undefined) {
                    var coordinates = feature.getGeometry().getCoordinates();
                    currentPinkey = feature.get('pinkey'); // aktuellen pinkey merken
                    currentPlankey = feature.get('plankey'); // aktuellen plankey merken
                    let content = '';

                    let pinname = feature.get('pinname')?.trim();
                    let pinlocation = feature.get('pinlocation')?.trim();
                    let pindesc = feature.get('pindesc')?.trim();
                    let plankey = feature.get('plankey')?.trim();
                    let pinkey = feature.get('pinkey')?.trim();

                    if (pinname) {
                        content += '<h4 class="popup-header">Bezeichnung:</h4><p class="popup-header">' + pinname + '</p><hr class="solid">';
                    }

                    if (pinlocation) {
                        content += '<h4 class="popup-header">Standort:</h4><p class="popup-header">' + pinlocation + '</p><hr class="solid">';
                    }

                    if (pindesc) {
                        content += '<h4 class="popup-header">Beschreibung:</h4><p class="popup-header">' + pindesc + '</p>';
                    }

                    // Falls alle Felder leer sind, Standardtext setzen
                    if (!content) {
                        content = '<h4 class="popup-header">Hinweis:</h4><p class="popup-header">Für diesen Pin sind noch keine Informationen verfügbar.</p>';
                    } else {
                        // Entferne das letzte `<hr>` falls vorhanden
                        content = content.replace(/<hr class="solid">$/, '');
                    }

                    // Zeige das Popup immer an
                    popupContent.innerHTML = content;
                    popupElement.style.display = 'block';
                    popup.setPosition(coordinates);
                } else {
                    popupElement.style.display = 'none';
                    currentPinkey = null; // kein Marker ausgewählt
                    currentPlankey = null;
                }
            });
        }

        function setMarkerPosition(lon, lat, pinname, pinlocation, pindesc, plankey, pinkey) {
            if (!mapReady) {
                pendingPositions.push({ lon, lat, pinname, pinlocation, pindesc, plankey, pinkey });
                return;
            }

            var iconStyle = new ol.style.Style({
                image: new ol.style.Icon({ src: '{icon}', scale: {iconzoom}, anchor: [0.5, 1], anchorXUnits: 'fraction', anchorYUnits: 'fraction' })
            });

            var marker = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])), pinname, pinlocation, pindesc, plankey, pinkey });
            marker.setStyle(iconStyle);
            vectorSource.addFeature(marker);
        }

        function setMultipleMarkers(positions) {
            positions.forEach(function (position) {
                setMarkerPosition(
                    position.lon,
                    position.lat,
                    position.pinname,
                    position.pinlocation,
                    position.pindesc,
                    position.plankey,
                    position.pinkey
                );
            });
        }

        function changeMapLayer(layer) { wmsLayer.getSource().updateParams({ LAYERS: layer, CACHEBUSTER: new Date().getTime() }); wmsLayer.getSource().refresh(); }
        function changeOverlayLayer(layer) { overlayLayer.getSource().updateParams({ LAYERS: layer, CACHEBUSTER: new Date().getTime() }); overlayLayer.getSource().refresh(); }

        function getMarkerCoordinates() {
            var features = vectorSource.getFeatures();
            return features.length ? JSON.stringify(features.map(f => { var c = ol.proj.toLonLat(f.getGeometry().getCoordinates()); return { lon: c[0], lat: c[1], pinkey: f.get('pinkey'), plankey: f.get('plankey') }; })) : null;
        }
        window.onload = function () {
            initMap();

            const sendButton = document.getElementById('sendButton');
            //sendButton.addEventListener('click', function () {
            //    if (window.jsBridge && window.jsBridge.invokeAction) {
            //        window.jsBridge.invokeAction("Hallo aus JS"); // Nachricht an C#
            //    } else {
            //        alert("Bridge noch nicht verfügbar!");
            //    }
            //});

            sendButton.addEventListener('click', function () {
                if (!currentPinkey || !currentPlankey) return;

                const payload = { pinkey: currentPinkey, plankey: currentPlankey };

                // Android: jsBridge existiert
                if (window.jsBridge && typeof window.jsBridge.invokeAction === 'function') {
                    window.jsBridge.invokeAction(JSON.stringify(payload));

                    // Windows: WebView2 Bridge
                } else if (window.chrome?.webview && typeof window.chrome.webview.postMessage === 'function') {
                    window.chrome.webview.postMessage(JSON.stringify(payload));

                    // Fallback
                } else {
                    alert("Bridge noch nicht verfügbar!");
                }
            });
        };
    </script>
</body>
</html>
